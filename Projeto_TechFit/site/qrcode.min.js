
(function(){
  function hash32(str){
    var h = 2166136261>>>0;
    for(var i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return h>>>0;
  }
  function drawGrid(ctx, size, bits){
    var n = 33; // grid size (33x33 to look like QR)
    var cell = Math.floor(size/n);
    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,size,size);
    ctx.fillStyle = "#000";
    // finder patterns
    function finder(x,y){
      ctx.fillRect(x*cell,y*cell,7*cell,7*cell);
      ctx.fillStyle="#fff"; ctx.fillRect((x+1)*cell,(y+1)*cell,5*cell,5*cell);
      ctx.fillStyle="#000"; ctx.fillRect((x+2)*cell,(y+2)*cell,3*cell,3*cell);
      ctx.fillStyle="#000";
    }
    finder(0,0); finder(n-7,0); finder(0,n-7);
    // timing pattern
    for(var i=8;i<n-8;i++){ if(i%2==0) ctx.fillRect(i*cell,6*cell,cell,cell); if(i%2==0) ctx.fillRect(6*cell,i*cell,cell,cell); }
    // data pseudo-random from bits
    for(var y=0;y<n;y++){
      for(var x=0;x<n;x++){
        // skip finder zones
        if((x<7 && y<7)||(x>=n-7 && y<7)||(x<7 && y>=n-7)) continue;
        if(x==6 || y==6) continue;
        var idx = (y*n+x);
        var on = ((bits>>(idx%32)) & 1) ^ ((x*y)&1);
        if(on){ ctx.fillRect(x*cell,y*cell,cell,cell); }
      }
    }
  }
  function QRCode(el, opts){
    this.el = el;
    this.opts = Object.assign({text:"", width:180, height:180}, opts||{});
    this.canvas = document.createElement("canvas");
    this.canvas.width = this.opts.width; this.canvas.height = this.opts.height;
    this.el.innerHTML = ""; this.el.appendChild(this.canvas);
    this.makeCode(this.opts.text||"");
  }
  QRCode.prototype.makeCode = function(text){
    var payload = String(text||"");
    var h = hash32(payload);
    var ctx = this.canvas.getContext("2d");
    drawGrid(ctx, Math.min(this.opts.width,this.opts.height), h);
  };
  window.QRCode = QRCode;
})();
